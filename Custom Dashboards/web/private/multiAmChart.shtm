<!DOCTYPE html>
<html>
    <head>
        <title>Complex AM Chart</title>
        
        
        <!-- Page Style -->
        <style type="text/css">
        </style>
        
        <!-- Scripts from Module Directory -->
        <script type="text/javascript" src="/modules/dashboards/web/js/jquery/jquery-1.11.1.js"></script>
        <!-- Charting Library -->
        <script type="text/javascript" src="/modules/dashboards/web/js/amcharts/amcharts.js"></script>
        <script type="text/javascript" src="/modules/dashboards/web/js/amcharts/serial.js"></script>
        <!-- Mango Rest API Helper -->
        <script type="text/javascript" src="/modules/dashboards/web/js/mangoApi.js"></script>         
        <!-- Mango AM Charts Helper -->
        <script type="text/javascript" src="/modules/dashboards/web/js/mangoAmChartsApi.js"></script>         
       
        <script type="text/javascript">
        
         var chart1Xids = ["temp","volts"];
         
         var chart1 = new MangoAmStockChartHelper({
             chartDivId: "chart1",
             xids: chart1Xids,
             //Operate on the PVT Object {time,value,...}
             //this needs to return the value member or some representation of it
             dataOperation: function(allData, pvt,xid){
                 if(xid === chart1Xids[0]){
                     return pvt.value * 0.01;
                 }else if(xid === chart1Xids[1]){
                     return pvt.value * 10;
                 }else{
                     return 0;
                 }
             },
             timeOperation: function(allData, pvt, xid){
               return pvt.time;  
             },
             chartJson: 
             {
                 "type": "serial",
                 //Note the path to images
                 "pathToImages": "/modules/dashboards/web/js/amcharts/images/",
                 //Set to date field in result data
                 "categoryField": "date",
                 "categoryAxis": {
                     "minPeriod": "ss",
                     "parseDates": true
                 },
                 "chartCursor": {
                     "categoryBalloonDateFormat": "JJ:NN:SS"
                 },
                 "chartScrollbar": {},
                 "trendLines": [],
                 //Note that each graph uses the valueField set to the XID of the point
                 "graphs": [
                     {
                         "bullet": "round",
                         "id": "AmGraph-1",
                         "title": chart1Xids[0],
                         "valueField": chart1Xids[0]
                     },
                     {
                         "bullet": "square",
                         "id": "AmGraph-2",
                         "title": chart1Xids[1],
                         "valueField": chart1Xids[1]
                     }
                 ],
                 "guides": [],
                 "valueAxes": [
                     {
                         "id": "ValueAxis-1",
                         "title": "Temperature"
                     }
                 ],
                 "allLabels": [],
                 "balloon": {},
                 "legend": {
                     "useGraphSettings": true
                 },
                 "titles": [
                     {
                         "id": "Title-1",
                         "size": 15,
                         "text": "Chart One"
                     }
                 ],
             }
     });
          
          //Hold the data
          var tempData,voltsData;
          var dataProvider = new Array();
          
          function DeferredAjax(opts) {
              this.options=opts;
              this.deferred=$.Deferred();
              this.xid=opts.xid;
              this.dataProvider = opts.dataProvider;
              this.from = opts.from;
              this.to = opts.to;
          }
          DeferredAjax.prototype.invoke=function() {
              var self=this, data={xid:self.xid};
              console.log("Making request for [" + self.xid + "]");

              return $.ajax({
                  url : "/rest/v1/pointValues/" + self.xid + ".json?from=" + self.from + "&to=" + self.to,
              }).done(function(data){
                  for(var i=0; i<data.length; i++){
                      var entry = {date: data[i].time};
                      entry[self.xid] = data[i].value;
                      self.dataProvider.push(entry);
                  }
                  self.deferred.resolve();
              });
              
              
          };
          DeferredAjax.prototype.promise=function() {
              return this.deferred.promise();
          };
          
          /**
           * Run on page load
           */
          $( document ).ready(function(){
              
              var startingpoint = $.Deferred();
              startingpoint.resolve();
              
              var to = new Date();
              var from = new Date(to.getTime() - 1000*60*60);
              
              $.each(chart1Xids, function(ix, xid){
                 var da = new DeferredAjax({
                     xid: xid,
                     dataProvider: dataProvider,
                     from: mangoRest.formatLocalDate(from),
                     to: mangoRest.formatLocalDate(to)
                 }); 
                 $.when(startingpoint).then(function(){
                     da.invoke();
                 });
                 startingpoint = da;
              });

              //chart1.addSeries('temp', data, false);
              $.when(startingpoint).then(function(){
                  console.log('Done: ' + dataProvider.length);
                  chart1.createChart(dataProvider);
              });
              
              //chart1.createChart();
                            
          });          
        </script>
        
    </head>
<body>
	<div id="chart1" style="width:100%; height:400px; vertical-align: top;  display: inline-block; padding: 10px;">
	</div>
</body>
</html>