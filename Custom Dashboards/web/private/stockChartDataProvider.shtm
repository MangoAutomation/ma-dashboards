<!DOCTYPE html>
<html>
    <head>
        <title>Pie AM Chart Example</title>
        
        
        <!-- Page Style -->
        <style type="text/css">
        </style>
        
        <!-- Scripts from Module Directory -->
        <script type="text/javascript" src="/modules/dashboards/web/js/jquery/jquery-1.11.1.js"></script>
        <!-- Charting Library -->
        <script type="text/javascript" src="/modules/dashboards/web/js/amcharts/amcharts.js"></script>
        <script type="text/javascript" src="/modules/dashboards/web/js/amcharts/pie.js"></script>
        <script type="text/javascript" src="/modules/dashboards/web/js/amcharts/serial.js"></script>
        <script type="text/javascript" src="/modules/dashboards/web/js/amcharts/amstock.js"></script>
        
        <!-- Mango Rest API Helper -->
        <script type="text/javascript" src="/modules/dashboards/web/js/mangoApi.js"></script>         
        <!-- Mango AM Charts Helper -->
        <script type="text/javascript" src="/modules/dashboards/web/js/mangoAmChartsApi.js"></script>   
        <!-- Mango Data Provider API -->      
        <script type="text/javascript" src="/modules/dashboards/web/js/mangoDataProvider.js"></script>   
       
        <script type="text/javascript">
        
        
          var to = new Date();
          var from = new Date(to.getTime() - 1000*60*60*12);
        
          var voltsDataProvider = new NumericDataProvider({
                  xid: 'volts',
                  from: from,
                  to: to,
                  rollup: 'AVERAGE',
                  timePeriodType: 'HOURS',
                  timePeriods: 1,
                  
                  errorDivId: 'errors',
                  timeDataAttribute: 'time',
                  valueDataAttribute: 'volts',
                  
          }); //Holds point values for use
          var tempDataProvider = new NumericDataProvider({
              xid: 'temp',
              from: from,
              to: to,
              rollup: 'FIRST',
              timePeriodType: 'MINUTES',
              timePeriods: 1,
              
              errorDivId: 'errors',
              timeDataAttribute: 'time',
              valueDataAttribute: 'temp',
              
          }); //Holds point values for use
          /**
           * Display Errors method
           */
          function showError(jqXHR, textStatus, errorThrown, mangoMessage){
              
              var msg = "";
              if(textStatus != null)
                  msg += (textStatus + " ");
              if(errorThrown != null)
                  msg += (errorThrown + " ");
              if(mangoMessage != null)
                  msg += (mangoMessage + " ");
              msg += "\n";
              $("#errors").text(msg);
          }
          /**
           * Run on page load
           */
          $( document ).ready(function(){
              
              
              var chart1 = new MangoAmHelper({
                  chartDivId: "chart1",
                  chartConfig: "/modules/dashboards/web/private/charts/simpleStock.json",
                  mixin: {
                      type: "stock",
                      categoryAxesSettings: {
                          minPeriod: "mm"
                      },
                      dataSets: [
                      {
                          title: "Volts",
                          fieldMappings: [{
                              fromField: "volts",
                              toField: "value"
                          }],
                          dataProvider: voltsDataProvider.data,
                          categoryField: "time"
                      },{
                          title: "Temperature",
                          fieldMappings: [{
                              fromField: "temp",
                              toField: "value"
                          }],
                          dataProvider: tempDataProvider.data,
                          categoryField: "time"
                      }],
                      panels: [{

                          showCategoryAxis: false,
                          title: "Value",
                          percentHeight: 70,

                          stockGraphs: [{
                              id: "g1",

                              valueField: "value",
                              comparable: true,
                              compareField: "value",
                              balloonText: "[[title]]:<b>[[value]]</b>",
                              compareGraphBalloonText: "[[title]]:<b>[[value]]</b>"
                          }],

                          stockLegend: {
                              periodValueTextComparing: "[[percents.value]]%",
                              periodValueTextRegular: "[[value]]"
                          }
                      }],
                      chartScrollbarSettings: {
                          graph: "g1"
                      },
                      periodSelector: {
                          position: "left",
                          periods: [
                           {
                               period: "mm",
                               selected: true,
                               count: 1,
                               label: "1 minute"
                           },                                    
                          {
                              period: "hh",
                              count: 1,
                              label: "1 hour"
                          },
                          {
                              period: "MM",
                              selected: true,
                              count: 1,
                              label: "1 month"
                          }, {
                              period: "YYYY",
                              count: 1,
                              label: "1 year"
                          }, {
                              period: "YTD",
                              label: "YTD"
                          }, {
                              period: "MAX",
                              label: "MAX"
                          }]
                      },

                  },
                  //Override the error method
                  showError: showError
              });
              $.when(chart1).then(function(){
                 $.when(voltsDataProvider).then(function(){
                     voltsDataProvider.addToStockChart(chart1.amChart, "Volts");
                     
                 });
                 $.when(tempDataProvider).then(function(){
                     tempDataProvider.addToStockChart(chart1.amChart, "Temperature");
                 });
              });
              
              //Pie Chart
              var pie1 = new MangoAmHelper({
                  
                  chartDivId: "pie1",
                  chartConfig: "/modules/dashboards/web/private/charts/simplePie.json",
                  mixin: {
                      valueField: "total",
                      titleField: "xid",
                      exportConfig: {
                          menuItems: [{
                             icon: "/modules/dashboards/web/js/amcharts/images/export.png",
                             format: "png"
                             }
                          ]
                      }
                  },
                  //Override the error method
                  showError: showError
              });
              
              $.when(pie1).then(function(){
                  $.when(voltsDataProvider).then(function(){
                      voltsDataProvider.addToPieChart(pie1.amChart, function(data, dataValueAttribute, timeValueAttribute){
                          //Massage the data
                          var total = 0;
                          for(var i in data){
                              total += data[i][dataValueAttribute];
                          }
                          return {"total": total, "xid": dataValueAttribute};
                      });
                  });
                  
                  $.when(tempDataProvider).then(function(){
                      tempDataProvider.addToPieChart(pie1.amChart, function(data, dataValueAttribute, timeValueAttribute){
                          //Massage the data
                          var total = 0;
                          for(var i in data){
                              total += data[i][dataValueAttribute];
                          }
                          return {"total": total, "xid": dataValueAttribute};
                      });
                  });

                  
                  
               });
              
              
              
          });          
        </script>
        
    </head>
<body>
    <div id="chart1" style="width:100%; height:400px; vertical-align: top;  display: inline-block; padding: 10px;">
    </div>
    <div id="pie1" style="width:100%; height:400px; vertical-align: top;  display: inline-block; padding: 10px;">
    </div>
    
    <!-- Placeholder to log errors -->
    <div id="errors" style="color: red"></div>    
</body>
</html>