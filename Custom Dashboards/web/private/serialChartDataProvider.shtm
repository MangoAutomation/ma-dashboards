<!DOCTYPE html>
<html>
    <head>
        <title>Pie AM Chart Example</title>
        
        
        <!-- Page Style -->
        <style type="text/css">
        </style>
        
        <!-- Scripts from Module Directory -->
        <script type="text/javascript" src="/modules/dashboards/web/js/jquery/jquery-1.11.1.js"></script>
        <!-- Charting Library -->
        <script type="text/javascript" src="/modules/dashboards/web/js/amcharts/amcharts.js"></script>
        <script type="text/javascript" src="/modules/dashboards/web/js/amcharts/pie.js"></script>
        <script type="text/javascript" src="/modules/dashboards/web/js/amcharts/serial.js"></script>
        <script type="text/javascript" src="/modules/dashboards/web/js/amcharts/amstock.js"></script>
        
        <!-- Mango Rest API Helper -->
        <script type="text/javascript" src="/modules/dashboards/web/js/mangoApi.js"></script>         
        <!-- Mango AM Charts Helper -->
        <script type="text/javascript" src="/modules/dashboards/web/js/mangoAmChartsApi.js"></script>   
        <!-- Mango Data Provider API -->      
        <script type="text/javascript" src="/modules/dashboards/web/js/mangoDataProvider.js"></script>   
       
        <script type="text/javascript">
            //Define chart first
	        var chart1 = new MangoAmHelper({
	            chartDivId: "chart1",
	            mixin: {
	                titles: [
	                           {
	                               id: "Title-1",
	                               size: 15,
	                               text: "Voltage And Temperature"
	                           }
	                       ],
	                categoryField: "time",
	                graphs: [{
	                    title: "Voltage",
	                    balloonText: "[[category]]<br><b><span style='font-size:14px;'>[[value]]</span></b>",
	                    bullet: "square",
	                    bulletSize: 6,
	                    lineColor: "green",
	                    lineThickness: 1,
	                    negativeLineColor: "red",
	                    type: "smoothedLine",
	                    valueField: "volts"
	                },{
	                    title: "Temperature",
	                    balloonText: "[[category]]<br><b><span style='font-size:14px;'>[[value]]</span></b>",
	                    bullet: "square",
	                    bulletSize: 6,
	                    lineColor: "orange",
	                    lineThickness: 1,
	                    negativeLineColor: "red",
	                    type: "step",
	                    valueField: "temp"
	                }
	                
	                ],
	            },
	            //Override the error method
	            showError: showError
	        });
        
          var to = new Date();
          var voltsOffset = 1000*30; //30s
          var tempOffset = 1000*60; //60s
          var voltsFrom = new Date(to.getTime() - voltsOffset);
          var tempFrom = new Date(to.getTime() - tempOffset);
          //Define Volts Data Provider
          var voltsDataProvider = new NumericDataProvider({
                  xid: 'volts',
                  from: voltsFrom,
                  to: to,
                  rollup: null, //'FIRST',
                  timePeriodType: null, //'SECONDS',
                  timePeriods: null, //1,
                  
                  serialCharts: [],
                  errorDivId: 'errors',
                  timeDataAttribute: 'time',
                  valueDataAttribute: 'volts',
                  
          });
          var tempDataProvider = new NumericDataProvider({
              xid: 'temp',
              from: tempFrom,
              to: to,
              rollup: 'AVERAGE',
              timePeriodType: 'SECONDS',
              timePeriods: 1,
              
              serialCharts: [],
              errorDivId: 'errors',
              timeDataAttribute: 'time',
              valueDataAttribute: 'temp',
              
          }); //Holds point values for use
          /**
           * Display Errors method
           */
          function showError(jqXHR, textStatus, errorThrown, mangoMessage){
              
              var msg = "";
              if(textStatus != null)
                  msg += (textStatus + " ");
              if(errorThrown != null)
                  msg += (errorThrown + " ");
              if(mangoMessage != null)
                  msg += (mangoMessage + " ");
              msg += "\n";
              $("#errors").text(msg);
          }
          /**
           * Run on page load
           */
          $( document ).ready(function(){

              $.when(chart1).then(function(){
                  
                  //Chart is ready, add to 
                  voltsDataProvider.serialCharts.push(chart1.amChart);
                  tempDataProvider.serialCharts.push(chart1.amChart);

                  setInterval(function(){
                      
                      //Reconfigure our dates
                      var to = new Date();
                      //voltsDataProvider.from = new Date(to.getTime() - voltsOffset);
                      voltsDataProvider.to = to;
                      //tempDataProvider.from = new Date(to.getTime() - tempOffset);
                      tempDataProvider.to = to;
                      var deferred = voltsDataProvider.load();
                      tempDataProvider.load();
                  }, 2000); //Every so often reload chart
              });
              
              //Pie Chart
              var pie1 = new MangoAmHelper({
                  
                  chartDivId: "pie1",
                  chartConfig: "/modules/dashboards/web/private/charts/simplePie.json",
                  mixin: {
                      valueField: "total",
                      titleField: "xid",
                      exportConfig: {
                          menuItems: [{
                             icon: "/modules/dashboards/web/js/amcharts/images/export.png",
                             format: "png"
                             }
                          ]
                      }
                  },
                  //Override the error method
                  showError: showError
              });
              
              $.when(pie1).then(function(){
                  $.when(voltsDataProvider).then(function(){
                      voltsDataProvider.addToPieChart(pie1.amChart, function(data, dataValueAttribute, timeValueAttribute){
                          //Massage the data
                          var total = 0;
                          for(var i in data){
                              total += data[i][dataValueAttribute];
                          }
                          return {"total": total, "xid": dataValueAttribute};
                      });
                  });
                  
                  $.when(tempDataProvider).then(function(){
                      tempDataProvider.addToPieChart(pie1.amChart, function(data, dataValueAttribute, timeValueAttribute){
                          //Massage the data
                          var total = 0;
                          for(var i in data){
                              total += data[i][dataValueAttribute];
                          }
                          return {"total": total, "xid": dataValueAttribute};
                      });
                  });

                  
                  
               });
              
              
              
          });          
        </script>
        
    </head>
<body>
    <div id="chart1" style="width:100%; height:400px; vertical-align: top;  display: inline-block; padding: 10px;">
    </div>
    <div id="pie1" style="width:100%; height:400px; vertical-align: top;  display: inline-block; padding: 10px;">
    </div>
    
    <!-- Placeholder to log errors -->
    <div id="errors" style="color: red"></div>    
</body>
</html>