<!DOCTYPE html>
<html>
    <head>
        <title>Pie AM Chart Example</title>
        
        
        <!-- Page Style -->
        <style type="text/css">
        </style>
        
        <!-- Scripts from Module Directory -->
        <script type="text/javascript" src="/modules/dashboards/web/js/jquery/jquery-1.11.1.js"></script>
        <!-- Charting Library -->
        <script type="text/javascript" src="/modules/dashboards/web/js/amcharts/amcharts.js"></script>
        <script type="text/javascript" src="/modules/dashboards/web/js/amcharts/pie.js"></script>
        <!-- Mango Rest API Helper -->
        <script type="text/javascript" src="/modules/dashboards/web/js/mangoApi.js"></script>         
        <!-- Mango AM Charts Helper -->
        <script type="text/javascript" src="/modules/dashboards/web/js/mangoAmChartsApi.js"></script>         
       
        <script type="text/javascript">
          var pie1 = new MangoAmHelper({
             
              chartDivId: "pie1",
              chartConfig: "/modules/dashboards/web/private/charts/simplePie.json",
              mixin: {
                  valueField: "starts", //Options are ["starts", "runtime", "proportion"]
                  titleField: "value",
                  exportConfig: {
                      menuItems: [{
                         icon: "/modules/dashboards/web/js/amcharts/images/export.png",
                         format: "png"
                         }
                      ]
                  }
              },
              //Override the error method
              showError: showError
          });
          var pie2 = new MangoAmHelper({
              
              chartDivId: "pie2",
              chartConfig: "/modules/dashboards/web/private/charts/simplePie.json",
              mixin: {
                  valueField: "runtime", //Options are ["starts", "runtime", "proportion"]
                  titleField: "value",
                  depth3D: 15,
                  balloonText: "[[title]]<br><span style='font-size:14px'><b>[[value]]</b> ([[percents]]%)</span>",
                  angle: 30,
                  exportConfig: {
                      menuItems: [{
                         icon: "/modules/dashboards/web/js/amcharts/images/export.png",
                         format: "png"
                         }
                      ]
                  }
              },
              //Override the error method
              showError: showError
          }); 
          /**
           * Display Errors method
           */
          function showError(jqXHR, textStatus, errorThrown, mangoMessage){
              
              var msg = "";
              if(textStatus != null)
                  msg += (textStatus + " ");
              if(errorThrown != null)
                  msg += (errorThrown + " ");
              if(mangoMessage != null)
                  msg += (mangoMessage + " ");
              msg += "\n";
              $("#errors").text(msg);
          }
          /**
           * Run on page load
           */
          $( document ).ready(function(){
              var to = new Date();
              var from = new Date(to.getTime() - 1000*60*60);
              
              pie1.prepareChart(function(dataProvider){
                 //Get the data for the chart, statistics 
                 mangoRest.pointValues.getStatistics("multistate", mangoRest.formatLocalDate(from), mangoRest.formatLocalDate(to), function(data){
                     
                     if(data.hasData === true){
                         //Push all data onto Pie Chart's data provider
                         for(var i in data.startsAndRuntime){
                             var st = data.startsAndRuntime[i];
                             dataProvider.push(st);
                         }
                         pie1.createChart();
                         
                         //TODO Implement Chaining
                         pie2.prepareChart(function(pie2DataProvider){
                            pie2.createChart(pie1.json.dataProvider); 
                         });
                     }
                     
                 }, showError);
              });
              
                            
          });          
        </script>
        
    </head>
<body>
    <span>Starts:</span>
    <div id="pie1" style="width:100%; height:400px; vertical-align: top;  display: inline-block; padding: 10px;">
    </div>
    <span>Runtime in milliseconds:</span>
    <div id="pie2" style="width:100%; height:400px; vertical-align: top;  display: inline-block; padding: 10px;">
    </div>    
    <!-- Placeholder to log errors -->
    <div id="errors" style="color: red"></div>    
</body>
</html>