<div ng-form="$ctrl.form" ma-validation-messages="$ctrl.validationMessages" flex="noshrink" layout="column">
    <md-tabs flex="noshrink" layout="column" ng-attr-md-dynamic-height="{{$ctrl.dynamicHeight}}" md-border-bottom="true" md-swipe-content="false" md-selected="$ctrl.activeTab">
        <md-tab>
            <md-tab-label>
                <span ma-tr="ui.app.dataSource"></span>
            </md-tab-label>
            <md-tab-body>
                <div class="md-padding ma-no-padding-bottom">
                    <div layout="row" layout-wrap layout-align="space-between start" class="ma-inputs-container">
                        
                        <div flex="100" flex-gt-md="50">
                            <md-switch name="enabled" ng-model="$ctrl.dataSource.enabled"><span ma-tr="common.enabled"></span></md-switch>
                        </div>
                        
                        <md-input-container flex="100" flex-gt-md="50">
                            <md-icon>settings</md-icon>
                            <label ma-tr="dsEdit.dataSourceType"></label>
                            <md-select name="modelType" ng-model="$ctrl.dataSource.modelType" ng-disabled="!$ctrl.dataSource.isNew()" ng-change="$ctrl.typeChanged()">
                                <md-option ng-repeat="type in $ctrl.types track by type.type" ng-value="type.type">
                                    <span ma-tr="{{type.description}}"></span>
                                </md-option>
                            </md-select>
                            <div ng-messages="$ctrl.form.modelType.$error">
                                <div ng-message="required" ma-tr="ui.app.required"></div>
                                <div ng-message="validationMessage" ng-bind="$ctrl.form.modelType.validationMessage"></div>
                            </div>
                        </md-input-container>

                        <md-input-container flex="100" flex-gt-md="50">
                            <md-icon>label</md-icon>
                            <label ma-tr="common.name"></label>
                            <input name="name" ng-model="$ctrl.dataSource.name" required>
                            <div ng-messages="$ctrl.form.name.$error">
                                <div ng-message="required" ma-tr="ui.app.required"></div>
                                <div ng-message="validationMessage" ng-bind="$ctrl.form.name.validationMessage"></div>
                            </div>
                        </md-input-container>
                        
                        <md-input-container flex="100" flex-gt-md="50">
                            <md-icon>label</md-icon>
                            <label ma-tr="common.xid"></label>
                            <input name="xid" ng-model="$ctrl.dataSource.xid" required>
                            <div ng-messages="$ctrl.form.xid.$error">
                                <div ng-message="required" ma-tr="ui.app.required"></div>
                                <div ng-message="validationMessage" ng-bind="$ctrl.form.xid.validationMessage"></div>
                            </div>
                        </md-input-container>

                        <md-input-container flex="100" flex-gt-md="50">
                            <md-icon>lock</md-icon>
                            <label ma-tr="dsEdit.permission.edit"></label>
                            <input name="editPermission" ng-model="$ctrl.dataSource.editPermission" pattern="^\s*[\w-]+?\s*(,\s*[\w-]+?\s*)*$">
                            <div ng-messages="$ctrl.form.editPermission.$error">
                                <div ng-message="pattern" ma-tr="ui.app.invalidPermissions"></div>
                                <div ng-message="validationMessage" ng-bind="$ctrl.form.editPermission.validationMessage"></div>
                            </div>
                            <ma-permissions-menu ng-model="$ctrl.dataSource.editPermission"></ma-permissions-menu>
                        </md-input-container>

                        <div flex="100" flex-gt-md="50" layout layout-align="start start" ng-if="$ctrl.typesByName[$ctrl.dataSource.modelType].polling">
                            <md-input-container flex>
                                <md-icon>timer</md-icon>
                                <label ma-tr="dsEdit.updatePeriod"></label>
                                <input name="pollPeriod.periods" ng-model="$ctrl.dataSource.pollPeriod.periods" required type="number" step="1" min="1">
                                <div ng-messages="$ctrl.form['pollPeriod.periods'].$error">
                                    <div ng-message="required" ma-tr="ui.app.required"></div>
                                    <div ng-message="validationMessage" ng-bind="$ctrl.form['pollPeriod.periods'].validationMessage"></div>
                                </div>
                            </md-input-container>
                            <md-input-container flex>
                                <label ma-tr="dsEdit.updatePeriod"></label>
                                <md-select name="pollPeriod.type" ng-model="$ctrl.dataSource.pollPeriod.type" required>
                                    <md-option ng-repeat="type in $ctrl.pollTimePeriods track by type.type" ng-value="type.type">
                                        <span ma-tr="{{type.translation}}"></span>
                                    </md-option>
                                </md-select>
                                <div ng-messages="$ctrl.form['pollPeriod.type'].$error">
                                    <div ng-message="validationMessage" ng-bind="$ctrl.form['pollPeriod.type'].validationMessage"></div>
                                </div>
                            </md-input-container>
                        </div>
                    </div>

                    <div ng-include="$ctrl.typesByName[$ctrl.dataSource.modelType].templateUrl"></div>
                </div>
            </md-tab-body>
        </md-tab>

        <md-tab>
            <md-tab-label>
                <span ma-tr="dsEdit.events.alarmLevels"></span>
            </md-tab-label>
            <md-tab-body>
                <div class="md-padding ma-no-padding-bottom">
                    <div layout="row" layout-wrap layout-align="space-between start" class="ma-inputs-container">
                        <md-input-container flex="100" flex-gt-md="50" ng-repeat="(key, level) in $ctrl.dataSource.alarmLevels">
                            <label ng-bind="key"></label>
                            <md-select name="alarmLevels.{{key}}" ng-model="$ctrl.dataSource.alarmLevels[key]" required ma-get-ctrl="modelCtrl = $ngModel">
                                <md-option ng-repeat="level in $ctrl.maEvents.levels track by level.key" ng-value="level.key">
                                    <md-icon class="fa fa-lg ma-alarm-flag" ng-class="level.classes"></md-icon>
                                    <span ma-tr="{{level.translation}}"></span>
                                </md-option>
                            </md-select>
                            <div ng-messages="modelCtrl.$error">
                                <div ng-message="required" ma-tr="ui.app.required"></div>
                                <div ng-message="validationMessage" ng-bind="modelCtrl.validationMessage"></div>
                            </div>
                        </md-input-container>
                    </div>
                </div>
            </md-tab-body>
        </md-tab>

        <md-tab>
            <md-tab-label>
                <span ma-tr="dsEdit.logging.purge"></span>
            </md-tab-label>
            <md-tab-body>
                <div class="md-padding ma-no-padding-bottom">
                    <div>
                        <md-checkbox name="purgeSettings.override" ng-model="$ctrl.dataSource.purgeSettings.override"><span ma-tr="dsEdit.logging.purgeOverride"></span></md-checkbox>
                    </div>
                    
                    <div layout layout-wrap layout-align="start start">
                        <div flex="100" flex-gt-md="50" layout layout-align="start start">
                            <md-input-container flex>
                                <md-icon>access_time</md-icon>
                                <label ma-tr="pointEdit.logging.after"></label>
                                <input name="purgeSettings.frequency.periods" ng-model="$ctrl.dataSource.purgeSettings.frequency.periods"
                                        required type="number" step="1" min="1" ng-disabled="!$ctrl.dataSource.purgeSettings.override">
                                <div ng-messages="$ctrl.form['purgeSettings.frequency.periods'].$error">
                                    <div ng-message="required" ma-tr="ui.app.required"></div>
                                    <div ng-message="validationMessage" ng-bind="$ctrl.form['purgeSettings.frequency.periods'].validationMessage"></div>
                                </div>
                            </md-input-container>
                            <md-input-container flex>
                                <label ma-tr="pointEdit.logging.after"></label>
                                <md-select name="purgeSettings.frequency.type" ng-model="$ctrl.dataSource.purgeSettings.frequency.type"
                                        required ng-disabled="!$ctrl.dataSource.purgeSettings.override">
                                    <md-option ng-repeat="type in $ctrl.purgeTimePeriods track by type.type" ng-value="type.type">
                                        <span ma-tr="{{type.translation}}"></span>
                                    </md-option>
                                </md-select>
                                <div ng-messages="$ctrl.form['purgeSettings.frequency.type'].$error">
                                    <div ng-message="validationMessage" ng-bind="$ctrl.form['purgeSettings.frequency.type'].validationMessage"></div>
                                </div>
                            </md-input-container>
                        </div>
                    </div>
                    
                    <h3 ma-tr="dsEdit.purge.purgeNow"></h3>
                    
                    <div>
                        <md-checkbox ng-init="purgeAll = false" ng-model="purgeAll" ma-form-exclude><span ma-tr="dsEdit.purge.allData"></span></md-checkbox>
                    </div>
                    
                    <div layout layout-wrap layout-align="start center">
                        <div flex="100" flex-gt-md="50" layout layout-align="start start">
                            <md-input-container flex>
                                <md-icon>access_time</md-icon>
                                <label ma-tr="dsEdit.purge.olderThan"></label>
                                <input ng-init="purgeNowPeriods = 1" ng-model="purgeNowPeriods" required type="number" step="1" min="1" ma-form-exclude ng-disabled="purgeAll">
                            </md-input-container>
                            <md-input-container flex>
                                <label ma-tr="dsEdit.purge.olderThan"></label>
                                <md-select ng-init="purgeNowType = 'YEARS'" ng-model="purgeNowType" required ma-form-exclude ng-disabled="purgeAll">
                                    <md-option ng-repeat="type in $ctrl.purgeTimePeriods track by type.type" ng-value="type.type">
                                        <span ma-tr="{{type.translation}}"></span>
                                    </md-option>
                                </md-select>
                            </md-input-container>
                        </div>
                        
                        <div flex="100" flex-gt-md="50">
                            <md-button class="md-warn" ng-click="$ctrl.purgeNow(purgeAll, purgeNowPeriods, purgeNowType)">
                                <md-icon>delete</md-icon> <span ma-tr="dsEdit.purge.purgeNow"></span>
                            </md-button>
                        </div>
                    </div>
                </div>
            </md-tab-body>
        </md-tab>

        <md-tab ng-if="!$ctrl.dataSource.isNew()" md-on-select="$ctrl.pointsTabActive = true" md-on-deselect="$ctrl.pointsTabActive = false">
            <md-tab-label>
                <span ma-tr="ui.app.dataPoints"></span>
            </md-tab-label>
            <md-tab-body>
                <div class="md-padding ma-no-padding-bottom">
                    <ma-bulk-data-point-editor data-source="$ctrl.dataSource" refresh="$ctrl.refresh" querying-disabled="!$ctrl.pointsTabActive"></ma-bulk-data-point-editor>
                </div>
            </md-tab-body>
        </md-tab>
    </md-tabs>

    <div class="md-padding" ng-if="$ctrl.form.validationMessage" ng-bind="$ctrl.form.validationMessage" role="alert" md-colors="::{color: 'warn'}"></div>

    <div class="md-padding ma-action-buttons" ng-if="!$ctrl.pointsTabActive">
        <md-button class="md-raised md-primary" ng-click="$ctrl.saveItem($event)" ng-disabled="!$ctrl.form">
            <md-icon>save</md-icon>
            <span ma-tr="common.save"></span>
        </md-button>
        <md-button class="md-raised" ng-click="$ctrl.revertItem($event)" ng-disabled="$ctrl.form.$pristine">
            <md-icon>undo</md-icon>
            <span ma-tr="ui.app.revert"></span>
        </md-button>
        <md-button class="md-raised md-warn" ng-click="$ctrl.deleteItem($event)" ng-disabled="$ctrl.dataSource.isNew()">
            <md-icon>delete</md-icon>
            <span ma-tr="common.delete"></span>
        </md-button>
    </div>
</div>
